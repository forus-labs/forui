name: Forui Goldens Commit

on:
  workflow_run:
    workflows: ["Forui Goldens Generate"]
    types: [completed]

jobs:
  commit:
    name: Commit Changes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      # Try to download PR metadata from either OS
      - id: download-metadata-macos
        continue-on-error: true
        uses: actions/download-artifact@v7
        with:
          name: pr-metadata-macos-latest
          path: ./pr-metadata
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - id: download-metadata-windows
        continue-on-error: true
        if: steps.download-metadata-macos.outcome == 'failure'
        uses: actions/download-artifact@v7
        with:
          name: pr-metadata-windows-latest
          path: ./pr-metadata
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - id: pr-metadata
        run: |
          echo "pr_number=$(cat ./pr-metadata/pr-number.txt)" >> $GITHUB_OUTPUT
          echo "pr_head_ref=$(cat ./pr-metadata/pr-head-ref.txt)" >> $GITHUB_OUTPUT
          echo "pr_head_sha=$(cat ./pr-metadata/pr-head-sha.txt)" >> $GITHUB_OUTPUT
          echo "pr_head_repo=$(cat ./pr-metadata/pr-head-repo.txt)" >> $GITHUB_OUTPUT

      # Download patches from both OS
      - id: download-patch-macos
        continue-on-error: true
        uses: actions/download-artifact@v7
        with:
          name: golden-changes-macos-latest
          path: ./
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - id: download-patch-windows
        continue-on-error: true
        uses: actions/download-artifact@v7
        with:
          name: golden-changes-windows-latest
          path: ./
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - id: check-changes
        run: |
          changes=false
          if [ -f "changes-macos-latest.patch" ] && [ -s "changes-macos-latest.patch" ]; then
            mv changes-macos-latest.patch ${{ runner.temp }}/changes-macos.patch
            changes=true
          fi
          if [ -f "changes-windows-latest.patch" ] && [ -s "changes-windows-latest.patch" ]; then
            mv changes-windows-latest.patch ${{ runner.temp }}/changes-windows.patch
            changes=true
          fi
          echo "changes=$changes" >> $GITHUB_OUTPUT

      - if: steps.check-changes.outputs.changes == 'true'
        uses: actions/create-github-app-token@v2
        id: generate-token
        with:
          app-id: ${{ secrets.AUTO_MAID_APP_ID }}
          private-key: ${{ secrets.AUTO_MAID_PRIVATE_KEY }}

      - if: steps.check-changes.outputs.changes == 'true'
        uses: actions/checkout@v6
        with:
          token: ${{ steps.generate-token.outputs.token }}
          repository: ${{ steps.pr-metadata.outputs.pr_head_repo }}
          ref: ${{ steps.pr-metadata.outputs.pr_head_ref }}

      - if: steps.check-changes.outputs.changes == 'true'
        run: |
          if [ -f "${{ runner.temp }}/changes-macos.patch" ]; then
            mv ${{ runner.temp }}/changes-macos.patch .
            git apply changes-macos.patch
            rm changes-macos.patch
          fi
          if [ -f "${{ runner.temp }}/changes-windows.patch" ]; then
            mv ${{ runner.temp }}/changes-windows.patch .
            git apply changes-windows.patch
            rm changes-windows.patch
          fi

      - if: steps.check-changes.outputs.changes == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          pull: '--rebase --autostash'
          message: 'Update goldens'
          add: '.'
